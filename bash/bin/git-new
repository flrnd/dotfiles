#!/bin/bash

issue=$1

if [ -z "$issue" ]; then
  echo "Please provide an issue number"
  exit 1
fi

issue=$(echo "$issue" | tr '[:upper:]' '[:lower:]')

jira_user=$JIRA_USER
jira_token=$JIRA_TOKEN

if [ -z "$jira_user" ] || [ -z "$jira_token" ]; then
  echo "Please set JIRA_USER and JIRA_TOKEN"
  exit 1
fi

uri="https://femtasy.atlassian.net/rest/api/2/issue/$issue"
response=$(curl -s -u "$jira_user:$jira_token" "$uri")

# Extract summary using basic string manipulations
summary=$(echo "$response" | grep -o '"summary":"[^"]*' | cut -d'"' -f4 | tr '[:upper:]' '[:lower:]' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e 's/[^a-zA-Z0-9]/-/g' -e 's/-\+/-/g')

if [[ $issue =~ ^fm- ]]; then
  # remove project prefix
  code=$(echo "$issue" | sed -e 's/^[[:alnum:]]\+-//')
else
  code=$issue
fi

git checkout -b "${code}-${summary}"
